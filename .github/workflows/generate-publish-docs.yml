name: Generate and publish documentation

on:
  push:
    branches:
      - main

jobs:
  documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v3
      - name: Generate Doxygen documentation
        uses: mattnotmitt/doxygen-action@v1.9.5
        with:
          working-directory: 'docs/doxygen'
      - name: Install Doxygen (for exhale)
        run: sudo apt-get update && sudo apt-get install -y doxygen
      - name: Add Doxygen to PATH
        run: echo "/usr/bin" >> $GITHUB_PATH
      - name: Check Doxygen Installation
        run: doxygen --version
      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
         auto-update-conda: true
         python-version: 3.11
      - name: Initialise conda
        run: conda init bash
      - name: Source .bashrc
        run: source ~/.bashrc
      - name: Create Conda environment
        run: conda create -n docs-env -y python=3.11
      - name: Activate Conda environment
        run: conda activate docs-env
      - name: Install sphinx with conda
        run: conda install sphinx
      - name: Install breathe with conda
        run: conda install conda-forge::breathe
      - name: Install exhale with conda
        run: pip install exhale
      - name: Install sphinx-book-theme with conda
        run: conda install conda-forge::sphinx-book-theme
      - name: Install sphinx-copybutton with conda
        run: conda install conda-forge::sphinx-copybutton 
      - name: Install sphinx-copybutton with conda
        run: conda install conda-forge::sphinx-toolbox
      - name: Process the Doxygen output using Sphinx
        run: sphinx-build -b html docs docs/sphinx
      - name: Deploy to Github pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs/sphinx
